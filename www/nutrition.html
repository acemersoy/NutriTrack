<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Besin Takibi - NutriTrack</title>
    <!-- Tema kontrolü - sayfa render edilmeden önce (Capacitor uyumlu) -->
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('nutritrack_theme') || 'light';
                if (document.documentElement) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    document.documentElement.classList.remove('theme-transition');
                } else if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        const theme = localStorage.getItem('nutritrack_theme') || 'light';
                        document.documentElement.setAttribute('data-theme', theme);
                        document.documentElement.classList.remove('theme-transition');
                    });
                }
            } catch(e) {
                if (document.documentElement) {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            }
        })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="db.js" defer></script>
    <script src="main.js" defer></script>
    <script src="smooth-scroll.js" defer></script>
    <script src="swipe.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding-bottom: 80px;
        }
        
        /* Transition SADECE kullanıcı etkileşiminde aktif */
        html.theme-transition body,
        html.theme-transition *,
        html.theme-transition *::before,
        html.theme-transition *::after {
            transition: background 0.3s ease !important, 
                       color 0.3s ease !important, 
                       border-color 0.3s ease !important, 
                       box-shadow 0.3s ease !important,
                       opacity 0.3s ease !important;
        }
        
        /* Varsayılan olarak transition YOK */
        html:not(.theme-transition) body,
        html:not(.theme-transition) *,
        html:not(.theme-transition) *::before,
        html:not(.theme-transition) *::after {
            transition: none !important;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* SEARCH SECTION - Material Design & WCAG */
        .search-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: background 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
        }

        [data-theme="dark"] .search-section {
            background: rgba(30, 30, 40, 0.95); /* Material Design: Surface */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(80, 80, 100, 0.3);
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e6e6e6;
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #1a1a1a;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        [data-theme="dark"] .search-input {
            background: rgba(40, 40, 55, 0.9);
            border-color: rgba(80, 80, 100, 0.5);
            color: rgba(255, 255, 255, 0.87); /* WCAG: High emphasis */
        }

        [data-theme="dark"] .search-input:focus {
            background: rgba(50, 50, 65, 0.95);
            border-color: rgba(102, 126, 234, 0.7);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        [data-theme="dark"] .search-input::placeholder {
            color: rgba(255, 255, 255, 0.38); /* Material Design: Disabled text */
        }

        .search-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .search-button:active {
            transform: translateY(0);
        }

        [data-theme="dark"] .search-button {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        [data-theme="dark"] .search-button:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .recommendations-section {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        [data-theme="dark"] .recommendations-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-color: rgba(102, 126, 234, 0.5);
        }

        .recommendations-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #667eea;
            font-size: 1rem;
        }

        [data-theme="dark"] .recommendations-header {
            color: #a0b4ff !important;
        }

        [data-theme="dark"] .recommendations-header span {
            color: #a0b4ff !important;
        }

        .recommendations-header i {
            font-size: 1.2rem;
        }

        /* CACHE QUICK ADD */
        .cache-section {
            margin: 18px 0 10px;
            background: #f8f9ff;
            border-radius: 14px;
            padding: 14px;
            border: 1px solid rgba(102,126,234,0.16);
            box-shadow: 0 10px 24px rgba(15,23,42,0.08);
        }
        [data-theme="dark"] .cache-section {
            background: rgba(26, 32, 54, 0.85);
            border-color: rgba(102,126,234,0.28);
        }
        .cache-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cache-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #667eea;
        }
        [data-theme="dark"] .cache-title { color: #a0b4ff; }
        .cache-actions {
            display: flex;
            gap: 8px;
        }
        .cache-refresh {
            border: 1px solid rgba(102,126,234,0.35);
            background: white;
            color: #667eea;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        [data-theme="dark"] .cache-refresh {
            background: rgba(255,255,255,0.08);
            color: #a0b4ff;
        }
        .cache-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
        }
        .cache-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(102,126,234,0.08);
            border: 1px solid rgba(102,126,234,0.16);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .cache-chip:hover {
            background: rgba(102,126,234,0.14);
            transform: translateY(-1px);
        }
        [data-theme="dark"] .cache-chip {
            background: rgba(102,126,234,0.12);
            border-color: rgba(102,126,234,0.28);
        }
        .cache-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }
        .cache-brand {
            font-size: 0.8rem;
            color: var(--muted);
        }
        .cache-add-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 6px 10px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(102,126,234,0.35);
        }
        .cache-empty {
            color: var(--muted);
            font-size: 0.9rem;
            padding: 12px 4px;
        }

        /* Cache meal modal */
        .cache-meal-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
            backdrop-filter: blur(4px);
        }
        .cache-meal-modal.active { display: flex; }
        .cache-meal-content {
            background: #fff;
            color: #1a1a1a;
            border-radius: 14px;
            padding: 18px;
            width: 320px;
            max-width: 92%;
            box-shadow: 0 18px 40px rgba(0,0,0,0.22);
            border: 1px solid rgba(102,126,234,0.22);
        }
        [data-theme="dark"] .cache-meal-content {
            background: rgba(26,32,54,0.95);
            color: #fff;
            border-color: rgba(102,126,234,0.35);
            box-shadow: 0 18px 40px rgba(0,0,0,0.55);
        }
        .cache-meal-title { font-weight: 700; margin: 0 0 10px; font-size: 1rem; }
        .cache-meal-buttons {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 10px;
            margin-top: 8px;
        }
        .cache-meal-btn {
            border: 1px solid rgba(102,126,234,0.35);
            background: rgba(102,126,234,0.12);
            color: #1a1a1a;
            border-radius: 10px;
            padding: 10px;
            cursor: true;
            font-weight: 600;
        }
        .cache-meal-btn:hover { background: rgba(102,126,234,0.18); }
        [data-theme="dark"] .cache-meal-btn {
            background: rgba(102,126,234,0.15);
            color: #fff;
            border-color: rgba(102,126,234,0.45);
        }
        [data-theme="dark"] .cache-meal-btn:hover { background: rgba(102,126,234,0.22); }

        .recommendations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .recommendations-list.empty {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            width: 100%;
        }
        .recipes-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 30px;
            min-height: 140px;
            color: #667eea;
            text-align: center;
            gap: 8px;
        }
        .recipes-empty i {
            font-size: 2rem;
            opacity: 0.7;
        }

        .recommendation-item {
            background: white;
            border: 2px solid #667eea;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #667eea;
            font-size: 0.9rem;
        }

        [data-theme="dark"] .recommendation-item {
            background: rgba(40, 40, 50, 0.9) !important;
            border-color: #8a9eff !important;
            color: #a0b4ff !important;
        }

        [data-theme="dark"] .recommendation-item span {
            color: #a0b4ff !important;
        }

        .recommendation-item:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        [data-theme="dark"] .recommendation-item:hover {
            background: #8a9eff;
            color: #ffffff;
        }

        .recommendation-badge {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        [data-theme="dark"] .recommendation-badge {
            background: rgba(138, 158, 255, 0.4) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .recommendation-item:hover .recommendation-badge {
            background: rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 15px;
            background: #ffffff;
            border: 1px solid #e6e6e6;
        }

        [data-theme="dark"] .search-results {
            background: rgba(30, 30, 40, 0.95);
            border: 1px solid rgba(64, 64, 80, 0.5);
        }

        .food-item {
            padding: 20px;
            border-bottom: 1px solid #e6e6e6;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }

        [data-theme="dark"] .food-item {
            background: rgba(35, 35, 45, 0.95) !important;
            border-bottom-color: rgba(80, 80, 100, 0.6);
            color: #ffffff;
            section-title {
                color: #010101;
            }
        }

        [data-theme="dark"] .food-item .food-name {
            color: #ffffff !important;
        }

        [data-theme="dark"] .food-item .food-brand {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .food-item .food-calories {
            color: #a0b4ff !important;
        }

        .food-item:hover {
            background: #e8f4fd;
        }

        [data-theme="dark"] .food-item:hover {
            background: rgba(50, 50, 60, 0.8);
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1a1a1a;
            font-size: 1rem;
        }

        [data-theme="dark"] .food-name {
            color: #ffffff !important;
            font-weight: 600;
        }

        .food-brand {
            color: #4a4a4a;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .food-brand {
            color: rgba(255, 255, 255, 0.60); /* Material Design: Medium emphasis */
        }

        .food-calories {
            color: #667eea;
            font-weight: 600;
        }

        /* NUTRITION DETAILS - Material Design & WCAG */
        .nutrition-details {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .nutrition-details {
            background: rgba(30, 30, 40, 0.95); /* Material Design: Surface */
            border: 1px solid rgba(80, 80, 100, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .nutrition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .food-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .food-title {
            color: rgba(255, 255, 255, 0.87); /* WCAG: High emphasis */
        }

        .portion-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-select {
            padding: 8px 12px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            color: #1a1a1a;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
            background: #ffffff;
        }

        [data-theme="dark"] .form-select {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(80, 80, 100, 0.6);
            color: #ffffff;
        }

        [data-theme="dark"] .form-select:focus {
            background: rgba(50, 50, 60, 0.9);
            border-color: #8a9eff;
        }

        [data-theme="dark"] .form-select option {
            background: rgba(40, 40, 50, 0.95);
            color: #ffffff;
        }

        /* MEAL SECTION - Material Design & WCAG */
        .meal-section {
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .meal-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .meal-title {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meal-calories {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meal-foods {
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            padding: 10px;
            transition: background 0.3s ease;
        }

        [data-theme="dark"] .meal-foods {
            background: rgba(25, 25, 35, 0.8); /* Material Design: Elevated Surface */
            border: 1px solid rgba(80, 80, 100, 0.3);
            border-top: none;
        }

        .portion-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            text-align: center;
        }

        .add-food-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-food-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .nutrition-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .nutrition-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .nutrition-label {
            color: #4a4a4a;
            font-size: 0.9rem;
        }

        /* MACRO SECTION - Material Design & WCAG */
        .macro-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .macro-section {
            background: rgba(30, 30, 40, 0.95); /* Material Design: Surface */
            border: 1px solid rgba(80, 80, 100, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* SECTION TITLE - Material Design & WCAG */
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .section-title {
            color: rgba(255, 255, 255, 0.87); /* WCAG: High emphasis */
        }

        [data-theme="dark"] .section-title i {
            color: #A0B4FF;
        }

        .today-foods {
            max-height: 300px;
            overflow-y: auto;
        }

        .today-food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e6e6e6;
            position: relative;
            background: #ffffff;
        }

        [data-theme="dark"] .today-food-item {
            background: rgba(40, 40, 50, 0.9) !important;
            border-bottom-color: rgba(80, 80, 100, 0.6);
            color: #ffffff;
        }

        [data-theme="dark"] .today-food-item .food-info {
            color: #ffffff;
        }

        .today-food-item:last-child {
            border-bottom: none;
        }

        .food-checkbox {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .food-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .settings-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* SETTINGS MENU - Material Design & WCAG */
        .settings-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            display: none;
            margin-top: 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .settings-menu {
            background: rgba(40, 40, 55, 0.98); /* Material Design: Elevated Surface */
            border: 1px solid rgba(80, 80, 100, 0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
        }

        .settings-menu.active {
            display: block;
        }

        .settings-menu-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid #e6e6e6;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1a1a1a;
        }

        [data-theme="dark"] .settings-menu-item {
            color: rgba(255, 255, 255, 0.87);
            border-bottom-color: rgba(80, 80, 100, 0.3);
        }

        .settings-menu-item:last-child {
            border-bottom: none;
        }

        .settings-menu-item:hover {
            background: #f8f9fa;
        }

        [data-theme="dark"] .settings-menu-item:hover {
            background: rgba(60, 60, 75, 0.8);
        }

        .settings-menu-item i {
            color: #667eea;
        }

        [data-theme="dark"] .settings-menu-item i {
            color: #A0B4FF;
        }

        /* BULK ACTIONS - Material Design & WCAG */
        .bulk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .bulk-actions {
            background: rgba(40, 40, 55, 0.9); /* Material Design: Component */
            border: 1px solid rgba(80, 80, 100, 0.3);
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #1a1a1a;
        }

        [data-theme="dark"] .bulk-actions-left {
            color: rgba(255, 255, 255, 0.87);
        }

        .bulk-actions-right {
            display: flex;
            gap: 10px;
        }

        .bulk-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .bulk-btn-move {
            background: #667eea;
            color: white;
        }

        .bulk-btn-move:hover {
            background: #5a67d8;
        }

        .bulk-btn-delete {
            background: #ff4757;
            color: white;
        }

        .bulk-btn-delete:hover {
            background: #ee3542;
        }

        /* MODAL - Material Design & WCAG */
        .meal-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .meal-select-modal {
            background: rgba(0,0,0,0.7);
        }

        .meal-select-modal.active {
            display: flex;
        }

        .meal-select-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .meal-select-content {
            background: rgba(30, 30, 40, 0.98); /* Material Design: Surface */
            border: 1px solid rgba(80, 80, 100, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .meal-select-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        [data-theme="dark"] .meal-select-title {
            color: rgba(255, 255, 255, 0.87); /* WCAG: High emphasis */
        }

        .meal-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .meal-option-btn {
            padding: 15px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
            color: #1a1a1a;
        }

        .meal-option-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        [data-theme="dark"] .meal-option-btn {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(80, 80, 100, 0.6);
            color: #ffffff;
        }

        [data-theme="dark"] .meal-option-btn:hover {
            background: rgba(50, 50, 60, 0.9);
            border-color: #8a9eff;
        }

        .modal-close-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Porsiyon seçim modal'ı */
        .serving-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .serving-select-modal {
            background: rgba(0,0,0,0.7);
        }

        .serving-select-modal.active {
            display: flex;
        }

        .serving-select-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .serving-select-content {
            background: rgba(30, 30, 40, 0.98);
            border: 1px solid rgba(80, 80, 100, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .serving-select-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        [data-theme="dark"] .serving-select-title {
            color: rgba(255, 255, 255, 0.87);
        }

        .serving-select-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 25px;
        }

        [data-theme="dark"] .serving-select-subtitle {
            color: rgba(255, 255, 255, 0.60);
        }

        .serving-input-group {
            margin-bottom: 25px;
        }

        .serving-input-label {
            display: block;
            font-size: 0.9rem;
            color: #4a4a4a;
            margin-bottom: 10px;
            font-weight: 500;
        }

        [data-theme="dark"] .serving-input-label {
            color: rgba(255, 255, 255, 0.60);
        }

        .serving-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: 600;
            color: #1a1a1a;
            transition: all 0.3s ease;
        }

        .serving-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        [data-theme="dark"] .serving-input {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(80, 80, 100, 0.6);
            color: #ffffff;
        }

        [data-theme="dark"] .serving-input:focus {
            border-color: #8a9eff;
            box-shadow: 0 0 0 3px rgba(138, 158, 255, 0.2);
        }

        .serving-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .serving-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .serving-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .serving-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .serving-btn-secondary {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        .serving-btn-secondary:hover {
            background: #e0e0e0;
        }

        [data-theme="dark"] .serving-btn-secondary {
            background: rgba(50, 50, 60, 0.8);
            color: #ffffff;
        }

        [data-theme="dark"] .serving-btn-secondary:hover {
            background: rgba(60, 60, 70, 0.9);
        }

        .food-info {
            flex: 1;
            color: #1a1a1a;
        }

        [data-theme="dark"] .food-info {
            color: #ffffff !important;
        }

        .food-amount {
            color: #4a4a4a;
            font-size: 0.9rem;
        }

        .food-nutrients {
            text-align: right;
            color: #667eea;
            font-weight: 700;
            font-size: 1rem;
        }

        [data-theme="dark"] .food-nutrients {
            color: #a0b4ff !important;
            font-weight: 700;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8rem;
        }

        /* LOADING & EMPTY STATES - Material Design & WCAG */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        [data-theme="dark"] .loading {
            color: rgba(255, 255, 255, 0.60); /* Material Design: Medium emphasis */
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        [data-theme="dark"] .loading i {
            color: rgba(255, 255, 255, 0.60);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NAVIGATION - Material Design & WCAG */
        /* Navigation stilleri styles.css'de tanımlı */

        /* SCROLLBAR - Material Design */
        .search-results::-webkit-scrollbar,
        .today-foods::-webkit-scrollbar,
        .meal-foods::-webkit-scrollbar {
            width: 8px;
        }

        .search-results::-webkit-scrollbar-track,
        .today-foods::-webkit-scrollbar-track,
        .meal-foods::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb,
        .today-foods::-webkit-scrollbar-thumb,
        .meal-foods::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb:hover,
        .today-foods::-webkit-scrollbar-thumb:hover,
        .meal-foods::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        [data-theme="dark"] .search-results::-webkit-scrollbar-track,
        [data-theme="dark"] .today-foods::-webkit-scrollbar-track,
        [data-theme="dark"] .meal-foods::-webkit-scrollbar-track {
            background: rgba(30, 30, 40, 0.5);
        }

        [data-theme="dark"] .search-results::-webkit-scrollbar-thumb,
        [data-theme="dark"] .today-foods::-webkit-scrollbar-thumb,
        [data-theme="dark"] .meal-foods::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
        }

        [data-theme="dark"] .search-results::-webkit-scrollbar-thumb:hover,
        [data-theme="dark"] .today-foods::-webkit-scrollbar-thumb:hover,
        [data-theme="dark"] .meal-foods::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .nutrition-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .nutrition-grid {
                grid-template-columns: 1fr;
            }

            .portion-control {
                flex-direction: column;
                align-items: stretch;
            }

            .portion-control > div {
                width: 100%;
            }

            .meal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .today-food-item {
                flex-wrap: wrap;
                gap: 10px;
            }

            .food-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 15px;
            }

            .bulk-actions-right {
                width: 100%;
                flex-direction: column;
            }

            .bulk-btn {
                width: 100%;
            }

            .meal-options {
                grid-template-columns: 1fr;
            }

            .settings-menu {
                right: auto;
                left: 0;
                min-width: 180px;
            }
        }

        /* Koyu mod için nutrition.html özel stilleri */
        [data-theme="dark"] .section-title {
            color: rgba(255, 255, 255, 0.87);
        }

        [data-theme="dark"] .nutrition-item {
            background: rgba(35, 35, 45, 0.95) !important;
            border: 1px solid rgba(80, 80, 100, 0.5);
        }

        [data-theme="dark"] .nutrition-value {
            color: #a0b4ff !important;
            font-weight: 700;
        }

        [data-theme="dark"] .nutrition-label {
            color: #e0e0e0 !important;
            font-weight: 500;
        }

        /* Açık mod için daha iyi kontrast */
        .section-title {
            color: #1a1a1a;
        }

        .nutrition-item {
            background: #ffffff;
            border: 1px solid #e6e6e6;
        }

        .nutrition-value {
            color: #667eea;
        }

        .nutrition-label {
            color: #1a1a1a;
        }

        /* Loading ve boş durumlar */
        .loading {
            color: #4a4a4a;
        }

        [data-theme="dark"] .loading {
            color: #e0e0e0 !important;
        }

        /* Koyu modda tüm besin listesi yazıları için zorunlu renkler */
        [data-theme="dark"] .meal-foods .food-name {
            color: #ffffff !important;
            font-weight: 600;
        }

        [data-theme="dark"] .meal-foods .food-amount {
            color: #e0e0e0 !important;
            font-weight: 500;
        }

        [data-theme="dark"] .meal-foods .food-nutrients {
            color: #a0b4ff !important;
            font-weight: 700;
        }

        [data-theme="dark"] .today-food-item .food-name {
            color: #ffffff !important;
            font-weight: 600;
        }

        [data-theme="dark"] .today-food-item .food-amount {
            color: #e0e0e0 !important;
            font-weight: 500;
        }

        [data-theme="dark"] .today-food-item .food-nutrients {
            color: #a0b4ff !important;
            font-weight: 700;
        }

        [data-theme="dark"] .search-results .food-name {
            color: #ffffff !important;
        }

        [data-theme="dark"] .search-results .food-brand {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .search-results .food-calories {
            color: #a0b4ff !important;
        }

        [data-theme="dark"] .search-input {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(64, 64, 80, 0.5);
            color: #ffffff;
        }

        [data-theme="dark"] .search-input:focus {
            background: rgba(50, 50, 60, 0.9);
            border-color: #667eea;
        }

        [data-theme="dark"] .portion-input {
            background: rgba(40, 40, 50, 0.8);
            border-color: rgba(64, 64, 80, 0.5);
            color: #ffffff;
        }

        [data-theme="dark"] .portion-input:focus {
            background: rgba(50, 50, 60, 0.9);
            border-color: #667eea;
        }

        /* MİKRO BESİN TAKİBİ STİLLERİ */
        .micronutrient-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        [data-theme="dark"] .tab-btn {
            background: rgba(40, 40, 50, 0.8);
            border-color: #8a9eff;
            color: #a0b4ff;
        }

        [data-theme="dark"] .tab-btn:hover {
            background: #8a9eff;
            color: #ffffff;
        }

        [data-theme="dark"] .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .micronutrient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .micronutrient-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .micronutrient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .micronutrient-card.status-low {
            border-color: #ff4757;
            background: linear-gradient(135deg, #fff5f5, #ffe5e5);
        }

        .micronutrient-card.status-fair {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fffbf0, #fff4e0);
        }

        .micronutrient-card.status-good {
            border-color: #27ae60;
            background: linear-gradient(135deg, #f0fff4, #e6ffe9);
        }

        .micronutrient-card.status-complete {
            border-color: #667eea;
            background: linear-gradient(135deg, #f5f7ff, #e8ecff);
        }

        .micronutrient-card.status-over {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff0f0, #ffe0e0);
        }

        [data-theme="dark"] .micronutrient-card {
            background: rgba(35, 35, 45, 0.9);
        }

        [data-theme="dark"] .micronutrient-card.status-low {
            background: rgba(139, 0, 0, 0.2);
            border-color: #ff6b6b;
        }

        [data-theme="dark"] .micronutrient-card.status-fair {
            background: rgba(255, 140, 0, 0.2);
            border-color: #ffa500;
        }

        [data-theme="dark"] .micronutrient-card.status-good {
            background: rgba(0, 128, 0, 0.2);
            border-color: #4caf50;
        }

        [data-theme="dark"] .micronutrient-card.status-complete {
            background: rgba(102, 126, 234, 0.2);
            border-color: #8a9eff;
        }

        .micronutrient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .micronutrient-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1a1a1a;
        }

        [data-theme="dark"] .micronutrient-name {
            color: #ffffff;
        }

        .micronutrient-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-low { background: #ff4757; color: white; }
        .badge-fair { background: #f39c12; color: white; }
        .badge-good { background: #27ae60; color: white; }
        .badge-complete { background: #667eea; color: white; }
        .badge-over { background: #ff6b6b; color: white; }

        .micronutrient-values {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .consumed-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #667eea;
        }

        [data-theme="dark"] .consumed-value {
            color: #a0b4ff;
        }

        .target-value {
            color: #666;
            font-size: 0.8rem;
        }

        [data-theme="dark"] .target-value {
            color: #b0b0b0;
        }

        .micronutrient-progress {
            width: 100%;
            height: 8px;
            background: #e6e6e6;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        [data-theme="dark"] .micronutrient-progress {
            background: rgba(60, 60, 70, 0.8);
        }

        .micronutrient-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .progress-bar-low { background: linear-gradient(90deg, #ff4757, #ff6b6b); }
        .progress-bar-fair { background: linear-gradient(90deg, #f39c12, #f1c40f); }
        .progress-bar-good { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .progress-bar-complete { background: linear-gradient(90deg, #667eea, #764ba2); }
        .progress-bar-over { background: linear-gradient(90deg, #ff6b6b, #ff8080); }

        .micronutrient-percentage {
            text-align: center;
            margin-top: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #667eea;
        }

        [data-theme="dark"] .micronutrient-percentage {
            color: #a0b4ff;
        }

        .no-micronutrients {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        [data-theme="dark"] .no-micronutrients {
            color: #b0b0b0;
        }

        @media (max-width: 768px) {
            .micronutrient-tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .tab-btn {
                flex-shrink: 0;
            }
            
            .micronutrient-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Tema Değiştir">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-utensils"></i> Besin Takibi</h1>
            <p>USDA veritabanı ile detaylı besin analizi</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" class="search-input" id="foodSearch" placeholder="Yiyecek ara (örn: elma, tavuk, ekmek)...">
                <button class="search-button" onclick="searchFood()">
                    <i class="fas fa-search"></i> Ara
                </button>
            </div>
            <div class="cache-section">
                <div class="cache-header">
                    <div class="cache-title"><i class="fas fa-database"></i> Son Beslendikleriniz</div>
                    <div class="cache-actions">
                        <button class="cache-refresh" onclick="loadCachedFoods()"><i class="fas fa-sync"></i> Yenile</button>
                    </div>
                </div>
                <div id="cacheList" class="cache-list">
                    <div class="cache-empty">Cache dolduğunda buradan tek tıkla öğüne ekleyebilirsiniz.</div>
                </div>
            </div>
            
            
            <!-- TARİFLER BÖLÜMÜ -->
            <div id="recipesSection" class="recommendations-section" style="display: none;">
                <div class="recommendations-header">
                    <i class="fas fa-book"></i>
                    <span>Tariflerim</span>
                    <a href="recipes.html" style="color: inherit; text-decoration: none; margin-left: auto; font-size: 0.9rem;">
                        <i class="fas fa-plus"></i> Yeni Tarif
                    </a>
                </div>
                <div id="recipesList" class="recommendations-list">
                    <!-- Tarifler buraya gelecek -->
                </div>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Cache öğün seçim modal -->
        <div class="cache-meal-modal" id="cacheMealModal" onclick="closeCacheMealModal(event)">
            <div class="cache-meal-content">
                <div class="cache-meal-title">Hangi öğüne eklemek istersiniz?</div>
                <div class="cache-meal-buttons">
                    <button class="cache-meal-btn" onclick="confirmAddCachedFood('breakfast')">🍳 Kahvaltı</button>
                    <button class="cache-meal-btn" onclick="confirmAddCachedFood('lunch')">🍽️ Öğle</button>
                    <button class="cache-meal-btn" onclick="confirmAddCachedFood('dinner')">🌙 Akşam</button>
                    <button class="cache-meal-btn" onclick="confirmAddCachedFood('snack')">🍎 Ara Öğün</button>
                </div>
            </div>
        </div>

        <div class="nutrition-details" id="nutritionDetails">
            <div class="nutrition-header">
                <div>
                    <h2 class="food-title" id="foodTitle">Yiyecek Adı</h2>
                    <div class="food-brand" id="foodBrand">Marka</div>
                </div>
                <div class="portion-control">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label>Öğün:</label>
                            <select class="form-select" id="mealType" style="padding: 8px 12px; border: 2px solid #e6e6e6; border-radius: 10px; font-size: 0.9rem;">
                                <option value="breakfast">Kahvaltı</option>
                                <option value="lunch">Öğle Yemeği</option>
                                <option value="dinner">Akşam Yemeği</option>
                                <option value="snack">Ara Öğün</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label>Miktar (g):</label>
                            <input type="number" class="portion-input" id="portionInput" value="100" min="1" onchange="updateNutrition()">
                            <button class="add-food-btn" onclick="addFood()">
                                <i class="fas fa-plus"></i> Ekle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nutrition-grid" id="nutritionGrid">
                <!-- Besin değerleri buraya gelecek -->
            </div>
        </div>

        <div class="macro-section">
            <h3 class="section-title"><i class="fas fa-chart-pie"></i> Bugün Tüketilenler</h3>
            <div class="bulk-actions" id="bulkActions">
                <div class="bulk-actions-left">
                    <span id="selectedCount">0 besin seçildi</span>
                </div>
                <div class="bulk-actions-right">
                    <button class="bulk-btn bulk-btn-move" onclick="showMoveMealModal()">
                        <i class="fas fa-arrow-right"></i> Taşı
                    </button>
                    <button class="bulk-btn bulk-btn-delete" onclick="deleteSelectedFoods()">
                        <i class="fas fa-trash"></i> Kaldır
                    </button>
                </div>
            </div>
            <div class="today-foods" id="todayFoods">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-utensils" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Henüz bir yiyecek eklemediniz</p>
                </div>
            </div>
        </div>

        <!-- MİKRO BESİN TAKİBİ YENİ BÖLÜM -->
        <div class="macro-section" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="section-title" style="margin-bottom: 0;"><i class="fas fa-flask"></i> Mikro Besin Takibi</h3>
                <div class="micronutrient-tabs">
                    <button class="tab-btn active" onclick="showMicroTab('all')">Tümü</button>
                    <button class="tab-btn" onclick="showMicroTab('vitamins')">Vitaminler</button>
                    <button class="tab-btn" onclick="showMicroTab('minerals')">Mineraller</button>
                    <button class="tab-btn" onclick="showMicroTab('deficient')">Eksikler</button>
                </div>
            </div>
            
            <div id="micronutrientsContainer">
                <div class="loading-micronutrients" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Besin değerleri hesaplanıyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Öğün Seçim Modalı -->
    <div class="meal-select-modal" id="mealSelectModal">
        <div class="meal-select-content">
            <h3 class="meal-select-title">Hangi Öğüne Taşımak İstersiniz?</h3>
            <div class="meal-options">
                <button class="meal-option-btn" onclick="moveFoodsToMeal('breakfast')">
                    <span style="font-size: 1.5rem; display: block; margin-bottom: 5px;">🍳</span>
                    Kahvaltı
                </button>
                <button class="meal-option-btn" onclick="moveFoodsToMeal('lunch')">
                    <span style="font-size: 1.5rem; display: block; margin-bottom: 5px;">🍽️</span>
                    Öğle Yemeği
                </button>
                <button class="meal-option-btn" onclick="moveFoodsToMeal('dinner')">
                    <span style="font-size: 1.5rem; display: block; margin-bottom: 5px;">🌙</span>
                    Akşam Yemeği
                </button>
                <button class="meal-option-btn" onclick="moveFoodsToMeal('snack')">
                    <span style="font-size: 1.5rem; display: block; margin-bottom: 5px;">🍎</span>
                    Ara Öğün
                </button>
            </div>
            <button class="modal-close-btn" onclick="document.getElementById('mealSelectModal').classList.remove('active')">
                İptal
            </button>
        </div>
    </div>

    <!-- Porsiyon seçim modal'ı -->
    <div class="serving-select-modal" id="servingSelectModal">
        <div class="serving-select-content">
            <h3 class="serving-select-title" id="servingSelectTitle">Kaç Porsiyon?</h3>
            <div class="serving-select-subtitle" id="servingSelectSubtitle">Tarif 1 porsiyonluk</div>
            <div class="serving-input-group">
                <label class="serving-input-label" for="servingInput">Porsiyon Sayısı</label>
                <input type="number" id="servingInput" class="serving-input" min="0.1" step="0.1" value="1" autofocus>
            </div>
            <div class="serving-buttons">
                <button class="serving-btn serving-btn-secondary" onclick="closeServingModal()">İptal</button>
                <button class="serving-btn serving-btn-primary" onclick="confirmServing()">Ekle</button>
            </div>
        </div>
    </div>

    <nav class="navigation">
        <a href="index.html" class="nav-item" title="Ana Sayfa"><i class="fas fa-home"></i></a>
        <a href="nutrition.html" class="nav-item active" title="Besin Takibi"><i class="fas fa-utensils"></i></a>
        <a href="recipes.html" class="nav-item" title="Tariflerim"><i class="fas fa-book"></i></a>
        <a href="profile.html" class="nav-item" title="Profil"><i class="fas fa-user"></i></a>
        <a href="progress.html" class="nav-item" title="İlerleme"><i class="fas fa-chart-bar"></i></a>
    </nav>

    <script>
        // USDA API anahtarı - ücretsiz olarak https://fdc.nal.usda.gov/api-key-signup.html adresinden alabilirsiniz
        const API_KEY = 'KbMh9bZk9sqAOgaAqsBdw77wn2hb31o7qRvJbzkH'; // Gerçek kullanım için kendi API key'inizi alın
        
        let currentFood = null;
        let lastSearchResults = []; // Son arama sonuçlarını sakla
        let baseNutrients = {};
        let selectedRecommendation = null;
        let selectedRecipeForQuickAdd = null;
        let pendingRecipeMealType = null; // Porsiyon seçimi için bekleyen öğün tipi

        // Yiyecek arama fonksiyonu (localStorage cache destekli)
        async function searchFood() {
            const query = document.getElementById('foodSearch').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><br>Aranıyor...</div>';

            const queryKey = `usda:${query.toLowerCase().trim()}`;
            const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 saat (milisaniye)

            // 1. Önce localStorage cache'de ara
            try {
                const cachedData = localStorage.getItem(queryKey);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    const now = Date.now();
                    const age = now - parsed.timestamp;
                    
                    if (age < CACHE_TTL) {
                        console.log(`📦 localStorage cache'den ${parsed.results.length} sonuç bulundu (${Math.round(age / 1000 / 60)} dakika önce)`);
                        displaySearchResults(parsed.results);
                        return;
                    } else {
                        // Süresi dolmuş, cache'i temizle
                        localStorage.removeItem(queryKey);
                        console.log(`⏰ Cache süresi dolmuş, temizlendi: ${queryKey}`);
                    }
                }
            } catch (error) {
                console.warn('localStorage cache okuma hatası:', error);
            }

            try {
                // Demo modunda örnek veri göster
                if (API_KEY === 'DEMO_KEY' || !API_KEY) {
                    showDemoResults(query);
                    return;
                }

                // Timeout ile fetch işlemi
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 saniye timeout

                try {
                    console.log(`🌐 USDA API'ye istek gönderiliyor: ${query}`);
                    const startTime = Date.now();
                    
                    const response = await fetch(
                        `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&api_key=${API_KEY}&pageSize=20`,
                        { 
                            signal: controller.signal,
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );
                    
                    clearTimeout(timeoutId);
                    
                    const responseTime = Date.now() - startTime;
                    console.log(`✅ API yanıt süresi: ${responseTime}ms, Status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`📊 API'den ${data.foods?.length || 0} sonuç alındı`);
                    
                    if (data.foods && data.foods.length > 0) {
                        // localStorage cache'e kaydet (24 saat TTL)
                        try {
                            localStorage.setItem(queryKey, JSON.stringify({
                                results: data.foods,
                                timestamp: Date.now()
                            }));
                            console.log(`💾 localStorage cache'e kaydedildi: ${queryKey}`);
                        } catch (e) {
                            console.warn('localStorage kayıt hatası (quota aşıldı olabilir):', e);
                        }
                        
                        displaySearchResults(data.foods);
                    } else {
                        resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Sonuç bulunamadı. Demo veriler gösteriliyor.</div>';
                        showDemoResults(query);
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    console.error('❌ USDA API hatası:', fetchError);
                    console.error('Hata detayı:', {
                        message: fetchError.message,
                        name: fetchError.name,
                        stack: fetchError.stack
                    });
                    
                    // CORS veya network hatası kontrolü
                    if (fetchError.message.includes('Failed to fetch') || fetchError.message.includes('NetworkError') || fetchError.name === 'TypeError') {
                        console.warn('⚠️ CORS veya network hatası tespit edildi. Android WebView\'de internet bağlantısını kontrol edin.');
                    }
                    
                    if (fetchError.name === 'AbortError') {
                        console.error('Arama zaman aşımına uğradı');
                        showNotification('Arama zaman aşımına uğradı. Demo veriler gösteriliyor.', 'error');
                    } else {
                        console.error('API hatası:', fetchError);
                        showNotification('API bağlantı hatası. Demo veriler gösteriliyor.', 'error');
                    }
                    
                    showDemoResults(query);
                }
            } catch (error) {
                console.error('Genel arama hatası:', error);
                showNotification('Bir hata oluştu. Demo veriler gösteriliyor.', 'error');
                showDemoResults(query);
            }
        }

        // Demo sonuçları göster
        function showDemoResults(query) {
            const demoFoods = [
                {
                    fdcId: 1,
                    description: 'Apple, raw',
                    brandOwner: 'Generic',
                    foodNutrients: [
                        { nutrientName: 'Energy', value: 52, unitName: 'kcal' },
                        { nutrientName: 'Protein', value: 0.3, unitName: 'g' },
                        { nutrientName: 'Carbohydrate, by difference', value: 14, unitName: 'g' },
                        { nutrientName: 'Total lipid (fat)', value: 0.2, unitName: 'g' },
                        { nutrientName: 'Fiber, total dietary', value: 2.4, unitName: 'g' },
                        { nutrientName: 'Sugars, total including NLEA', value: 10, unitName: 'g' }
                    ]
                },
                {
                    fdcId: 2,
                    description: 'Chicken breast, grilled',
                    brandOwner: 'Generic',
                    foodNutrients: [
                        { nutrientName: 'Energy', value: 165, unitName: 'kcal' },
                        { nutrientName: 'Protein', value: 31, unitName: 'g' },
                        { nutrientName: 'Carbohydrate, by difference', value: 0, unitName: 'g' },
                        { nutrientName: 'Total lipid (fat)', value: 3.6, unitName: 'g' },
                        { nutrientName: 'Fiber, total dietary', value: 0, unitName: 'g' },
                        { nutrientName: 'Sugars, total including NLEA', value: 0, unitName: 'g' }
                    ]
                },
                {
                    fdcId: 3,
                    description: 'Banana, raw',
                    brandOwner: 'Generic',
                    foodNutrients: [
                        { nutrientName: 'Energy', value: 89, unitName: 'kcal' },
                        { nutrientName: 'Protein', value: 1.1, unitName: 'g' },
                        { nutrientName: 'Carbohydrate, by difference', value: 23, unitName: 'g' },
                        { nutrientName: 'Total lipid (fat)', value: 0.3, unitName: 'g' },
                        { nutrientName: 'Fiber, total dietary', value: 2.6, unitName: 'g' },
                        { nutrientName: 'Sugars, total including NLEA', value: 12, unitName: 'g' }
                    ]
                }
            ];

            // Arama sorgusuna göre filtrele veya ekle
            const filteredFoods = demoFoods.filter(food => 
                food.description.toLowerCase().includes(query.toLowerCase())
            );

            displaySearchResults(filteredFoods);
        }

        // Arama sonuçlarını göster
        function displaySearchResults(foods) {
            const resultsDiv = document.getElementById('searchResults');
            
            // Son arama sonuçlarını sakla (tekrar arama yapmadan eklemek için)
            lastSearchResults = foods;
            
            if (foods.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Sonuç bulunamadı</div>';
                return;
            }

            resultsDiv.innerHTML = foods.map(food => `
                <div class="food-item" onclick="selectFood(${JSON.stringify(food).replace(/"/g, '&quot;')})">
                    <div>
                        <div class="food-name">${food.description || food.lowercaseDescription || 'Bilinmeyen'}</div>
                        <div class="food-brand">${food.brandOwner || 'Genel'}</div>
                    </div>
                    <div class="food-calories">
                        ${getCalories(food)} kcal
                    </div>
                </div>
            `).join('');
        }

        // Kalori değerini al
        function getCalories(food) {
            const energyNutrient = food.foodNutrients.find(n => 
                n.nutrientName && n.nutrientName.toLowerCase().includes('energy')
            );
            return energyNutrient ? Math.round(energyNutrient.value) : 0;
        }

        // Yiyecek seçimi
        function selectFood(food) {
            currentFood = food;
            baseNutrients = {};
            
            // Besin değerlerini düzenle
            food.foodNutrients.forEach(nutrient => {
                baseNutrients[nutrient.nutrientName] = {
                    value: nutrient.value,
                    unit: nutrient.unitName
                };
            });

            // Besin seçildiğinde cache'e kaydet (arka planda)
            if (typeof foodCache !== 'undefined' && food.fdcId) {
                foodCache.saveFood(food).catch(error => {
                    console.warn('Cache kayıt hatası:', error);
                });
            }

            document.getElementById('foodTitle').textContent = food.description || food.lowercaseDescription;
            document.getElementById('foodBrand').textContent = food.brandOwner || 'Genel';
            document.getElementById('nutritionDetails').style.display = 'block';
            document.getElementById('portionInput').value = 100;
            
            updateNutrition();
        }

        // Besin değerlerini güncelle
        function updateNutrition() {
            if (!currentFood) return;

            const portion = parseFloat(document.getElementById('portionInput').value) || 100;
            const multiplier = portion / 100;

            const nutritionGrid = document.getElementById('nutritionGrid');
            
            const importantNutrients = [
                'Energy', 'Protein', 'Carbohydrate, by difference', 'Total lipid (fat)',
                'Fiber, total dietary', 'Sugars, total including NLEA', 'Sodium, Na',
                'Calcium, Ca', 'Iron, Fe', 'Vitamin C, total ascorbic acid'
            ];

            const nutrientLabels = {
                'Energy': 'Kalori',
                'Protein': 'Protein',
                'Carbohydrate, by difference': 'Karbonhidrat',
                'Total lipid (fat)': 'Yağ',
                'Fiber, total dietary': 'Lif',
                'Sugars, total including NLEA': 'Şeker',
                'Sodium, Na': 'Sodyum',
                'Calcium, Ca': 'Kalsiyum',
                'Iron, Fe': 'Demir',
                'Vitamin C, total ascorbic acid': 'C Vitamini'
            };

            let html = '';
            importantNutrients.forEach(nutrientName => {
                const nutrient = baseNutrients[nutrientName];
                if (nutrient) {
                    const value = Math.round(nutrient.value * multiplier * 100) / 100;
                    const label = nutrientLabels[nutrientName] || nutrientName;
                    
                    html += `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${value}</div>
                            <div class="nutrition-label">${label} (${nutrient.unit})</div>
                        </div>
                    `;
                }
            });

            nutritionGrid.innerHTML = html;
        }

        // Yiyecek ekleme
        function addFood() {
            if (!currentFood) return;

            const portion = parseFloat(document.getElementById('portionInput').value) || 100;
            const multiplier = portion / 100;
            
            // Bugünkü verileri al
            let todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            if (!todayData.foods) todayData.foods = [];
            if (!todayData.calories) todayData.calories = 0;

            const mealType = document.getElementById('mealType').value;
            
            const foodItem = {
                id: Date.now(),
                name: currentFood.description || currentFood.lowercaseDescription,
                brand: currentFood.brandOwner || 'Genel',
                amount: portion,
                calories: Math.round(getCalories(currentFood) * multiplier),
                mealType: mealType, // Öğün tipini ekle
                nutrients: {}
            };

            // TÜM besin değerlerini kaydet (mikro besinler dahil)
            Object.keys(baseNutrients).forEach(nutrientName => {
                const nutrient = baseNutrients[nutrientName];
                const value = nutrient.value * multiplier;
                
                // Tüm besin değerlerini sakla
                if (value && value > 0) {
                    foodItem.nutrients[nutrientName] = {
                        value: Math.round(value * 1000) / 1000, // 3 ondalık basamak
                        unit: nutrient.unit
                    };
                }
                
                // Hızlı erişim için temel besinler
                if (nutrientName.toLowerCase().includes('energy')) {
                    foodItem.nutrients.calories = Math.round(value);
                } else if (nutrientName.toLowerCase().includes('protein') && !nutrientName.toLowerCase().includes('fat')) {
                    foodItem.nutrients.protein = Math.round(value * 100) / 100;
                } else if (nutrientName.toLowerCase().includes('carbohydrate')) {
                    foodItem.nutrients.carbs = Math.round(value * 100) / 100;
                } else if (nutrientName.toLowerCase().includes('fat') && !nutrientName.toLowerCase().includes('protein')) {
                    foodItem.nutrients.fat = Math.round(value * 100) / 100;
                }
            });

            // Aynı besin aynı öğünde var mı kontrol et
            const existingFoodIndex = todayData.foods.findIndex(f => 
                f.name === foodItem.name && 
                f.brand === foodItem.brand && 
                f.mealType === foodItem.mealType
            );

            if (existingFoodIndex !== -1) {
                // Mevcut besini bul ve birleştir
                const existingFood = todayData.foods[existingFoodIndex];
                
                // Miktarları topla
                existingFood.amount += foodItem.amount;
                
                // Kalorileri topla
                const oldCalories = existingFood.calories;
                existingFood.calories += foodItem.calories;
                
                // Toplam kaloriyi güncelle (eski kaloriyi çıkar, yeni toplamı ekle)
                todayData.calories = (todayData.calories || 0) - oldCalories + existingFood.calories;
                
                // TÜM besin değerlerini topla (mikro besinler dahil)
                if (existingFood.nutrients && foodItem.nutrients) {
                    // Hızlı erişim için temel besinler
                    existingFood.nutrients.calories = (existingFood.nutrients.calories || 0) + (foodItem.nutrients.calories || 0);
                    existingFood.nutrients.protein = ((existingFood.nutrients.protein || 0) + (foodItem.nutrients.protein || 0));
                    existingFood.nutrients.carbs = ((existingFood.nutrients.carbs || 0) + (foodItem.nutrients.carbs || 0));
                    existingFood.nutrients.fat = ((existingFood.nutrients.fat || 0) + (foodItem.nutrients.fat || 0));
                    
                    // Tüm mikro besinleri topla
                    Object.keys(foodItem.nutrients).forEach(nutrientKey => {
                        const newNutrient = foodItem.nutrients[nutrientKey];
                        if (typeof newNutrient === 'object' && newNutrient.value !== undefined) {
                            if (!existingFood.nutrients[nutrientKey]) {
                                existingFood.nutrients[nutrientKey] = { value: 0, unit: newNutrient.unit };
                            }
                            existingFood.nutrients[nutrientKey].value += newNutrient.value;
                            existingFood.nutrients[nutrientKey].value = Math.round(existingFood.nutrients[nutrientKey].value * 1000) / 1000;
                        }
                    });
                } else {
                    existingFood.nutrients = foodItem.nutrients;
                }
                
                // Mevcut besini güncelle
                todayData.foods[existingFoodIndex] = existingFood;
                
                // Yeni besin ekleme, sadece güncelleme yapıldı
            } else {
                // Yeni besin, normal şekilde ekle
                todayData.foods.push(foodItem);
                todayData.calories += foodItem.calories;
            }

            localStorage.setItem('nutritrack_today', JSON.stringify(todayData));
            
            // App state'i senkronize et ki mikro besin hesapları anında güncellensin
            if (typeof app !== 'undefined') {
                app.todayData = todayData;
                if (typeof app.saveTodayData === 'function') {
                    app.saveTodayData();
                }
            }
            
            // Geçmiş verileri de kaydet (tarih bazlı)
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD formatı
            let historyData = JSON.parse(localStorage.getItem('nutritrack_history') || '{}');
            
            if (!historyData[today]) {
                historyData[today] = {
                    foods: [],
                    calories: 0,
                    water: todayData.water || 0
                };
            }
            
            // Geçmiş verilerde de aynı kontrolü yap
            const existingHistoryFoodIndex = historyData[today].foods.findIndex(f => 
                f.name === foodItem.name && 
                f.brand === foodItem.brand && 
                f.mealType === foodItem.mealType
            );

            if (existingHistoryFoodIndex !== -1) {
                // Mevcut besini bul ve birleştir
                const existingHistoryFood = historyData[today].foods[existingHistoryFoodIndex];
                
                // Miktarları topla
                existingHistoryFood.amount += foodItem.amount;
                
                // Kalorileri topla
                const oldHistoryCalories = existingHistoryFood.calories;
                existingHistoryFood.calories += foodItem.calories;
                
                // Toplam kaloriyi güncelle
                historyData[today].calories = (historyData[today].calories || 0) - oldHistoryCalories + existingHistoryFood.calories;
                
                // TÜM besin değerlerini topla (mikro besinler dahil)
                if (existingHistoryFood.nutrients && foodItem.nutrients) {
                    // Hızlı erişim için temel besinler
                    existingHistoryFood.nutrients.calories = (existingHistoryFood.nutrients.calories || 0) + (foodItem.nutrients.calories || 0);
                    existingHistoryFood.nutrients.protein = ((existingHistoryFood.nutrients.protein || 0) + (foodItem.nutrients.protein || 0));
                    existingHistoryFood.nutrients.carbs = ((existingHistoryFood.nutrients.carbs || 0) + (foodItem.nutrients.carbs || 0));
                    existingHistoryFood.nutrients.fat = ((existingHistoryFood.nutrients.fat || 0) + (foodItem.nutrients.fat || 0));
                    
                    // Tüm mikro besinleri topla
                    Object.keys(foodItem.nutrients).forEach(nutrientKey => {
                        const newNutrient = foodItem.nutrients[nutrientKey];
                        if (typeof newNutrient === 'object' && newNutrient.value !== undefined) {
                            if (!existingHistoryFood.nutrients[nutrientKey]) {
                                existingHistoryFood.nutrients[nutrientKey] = { value: 0, unit: newNutrient.unit };
                            }
                            existingHistoryFood.nutrients[nutrientKey].value += newNutrient.value;
                            existingHistoryFood.nutrients[nutrientKey].value = Math.round(existingHistoryFood.nutrients[nutrientKey].value * 1000) / 1000;
                        }
                    });
                } else {
                    existingHistoryFood.nutrients = foodItem.nutrients;
                }
                
                // Mevcut besini güncelle
                historyData[today].foods[existingHistoryFoodIndex] = existingHistoryFood;
            } else {
                // Yeni besin, normal şekilde ekle
                historyData[today].foods.push(foodItem);
                historyData[today].calories += foodItem.calories;
            }
            
            historyData[today].water = todayData.water || 0;
            
            localStorage.setItem('nutritrack_history', JSON.stringify(historyData));
            
            updateTodayFoodsList();
            updateMicronutrients();
            
            // Bildirim mesajı
            if (existingFoodIndex !== -1) {
                const updatedFood = todayData.foods[existingFoodIndex];
                showNotification(`${foodItem.name} güncellendi! (Toplam: ${updatedFood.amount}g, ${updatedFood.calories} kcal)`);
            } else {
                showNotification(`${foodItem.name} eklendi! (+${foodItem.calories} kcal)`);
            }
            
            // Detayları gizle
            document.getElementById('nutritionDetails').style.display = 'none';
            document.getElementById('foodSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Bugünkü yiyecekleri güncelle
        function updateTodayFoodsList() {
            const todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            const foodsList = document.getElementById('todayFoods');
            
            if (!todayData.foods || todayData.foods.length === 0) {
                foodsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-utensils" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Henüz bir yiyecek eklemediniz</p>
                    </div>
                `;
                return;
            }

            // Öğünlere göre grupla
            const mealGroups = {
                breakfast: { foods: [], totalCalories: 0, label: 'Kahvaltı', icon: '🍳' },
                lunch: { foods: [], totalCalories: 0, label: 'Öğle Yemeği', icon: '🍽️' },
                dinner: { foods: [], totalCalories: 0, label: 'Akşam Yemeği', icon: '🌙' },
                snack: { foods: [], totalCalories: 0, label: 'Ara Öğün', icon: '🍎' }
            };

            // Yiyecekleri öğünlere göre grupla
            todayData.foods.forEach(food => {
                const mealType = food.mealType || 'snack'; // Varsayılan ara öğün
                if (mealGroups[mealType]) {
                    mealGroups[mealType].foods.push(food);
                    mealGroups[mealType].totalCalories += food.calories || 0;
                }
            });

            // HTML oluştur
            let html = '';
            const mealOrder = ['breakfast', 'lunch', 'dinner', 'snack'];
            
            mealOrder.forEach(mealKey => {
                const meal = mealGroups[mealKey];
                if (meal.foods.length > 0) {
                    html += `
                        <div class="meal-section">
                            <div class="meal-header">
                                <div class="meal-title">
                                    <span>${meal.icon}</span>
                                    <span>${meal.label}</span>
                                </div>
                                <div class="meal-calories">${Math.round(meal.totalCalories)} kcal</div>
                            </div>
                            <div class="meal-foods">
                                ${meal.foods.map(food => `
                                    <div class="today-food-item" data-food-id="${food.id}">
                                        <input type="checkbox" class="food-checkbox" data-food-id="${food.id}" onchange="updateBulkActions()">
                                        <div class="food-info" style="flex: 1;">
                                            <div class="food-name">${food.name}</div>
                                            <div class="food-amount">${food.amount}g • ${food.brand}</div>
                                        </div>
                                        <div class="food-nutrients">
                                            ${food.calories} kcal
                                        </div>
                                        <div class="food-actions">
                                            <button class="settings-btn" onclick="toggleSettingsMenu(${food.id}, event)">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            <div class="settings-menu" id="settingsMenu${food.id}">
                                                <div class="settings-menu-item" onclick="showMoveMealModal(${food.id})">
                                                    <i class="fas fa-arrow-right"></i>
                                                    <span>Başka Öğüne Taşı</span>
                                                </div>
                                                <div class="settings-menu-item" onclick="removeFood(${food.id})">
                                                    <i class="fas fa-trash"></i>
                                                    <span>Kaldır</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            foodsList.innerHTML = html || `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-utensils" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Henüz bir yiyecek eklemediniz</p>
                </div>
            `;
        }

        // Ayar menüsünü aç/kapat
        function toggleSettingsMenu(foodId, event) {
            event.stopPropagation();
            
            // Tüm menüleri kapat
            document.querySelectorAll('.settings-menu').forEach(menu => {
                menu.classList.remove('active');
            });
            
            // Tıklanan menüyü aç/kapat
            const menu = document.getElementById(`settingsMenu${foodId}`);
            if (menu) {
                menu.classList.toggle('active');
            }
            
            // Dışarı tıklanınca menüyü kapat
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    document.querySelectorAll('.settings-menu').forEach(m => m.classList.remove('active'));
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        // Toplu işlemler bölümünü güncelle
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.food-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (checkboxes.length > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = `${checkboxes.length} besin seçildi`;
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Seçili besinleri al
        function getSelectedFoodIds() {
            const checkboxes = document.querySelectorAll('.food-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.foodId));
        }

        // Seçili besinleri kaldır
        function deleteSelectedFoods() {
            const selectedIds = getSelectedFoodIds();
            
            if (selectedIds.length === 0) {
                showNotification('Lütfen kaldırmak istediğiniz besinleri seçin', 'error');
                return;
            }
            
            if (!confirm(`${selectedIds.length} besin kaldırılacak. Emin misiniz?`)) {
                return;
            }
            
            selectedIds.forEach(id => {
                removeFood(id);
            });
            
            updateBulkActions();
            showNotification(`${selectedIds.length} besin kaldırıldı!`);
        }

        // Öğün seçim modalını göster
        function showMoveMealModal(singleFoodId = null) {
            const modal = document.getElementById('mealSelectModal');
            const selectedIds = singleFoodId ? [singleFoodId] : getSelectedFoodIds();
            
            if (selectedIds.length === 0 && !singleFoodId) {
                showNotification('Lütfen taşımak istediğiniz besinleri seçin', 'error');
                return;
            }
            
            // Tüm ayar menülerini kapat
            document.querySelectorAll('.settings-menu').forEach(menu => {
                menu.classList.remove('active');
            });
            
            modal.dataset.foodIds = JSON.stringify(selectedIds);
            modal.classList.add('active');
        }

        // Besinleri başka öğüne taşı veya yeni besin/tarif ekle
        function moveFoodsToMeal(newMealType) {
            const modal = document.getElementById('mealSelectModal');
            
            // Eğer öneri seçildiyse
            if (selectedRecommendation) {
                addRecommendationToMeal(newMealType);
                return;
            }
            
            // Eğer tarif seçildiyse
            if (selectedRecipeForQuickAdd) {
                addRecipeToMeal(newMealType);
                return;
            }
            
            // Normal besin taşıma
            const foodIds = JSON.parse(modal.dataset.foodIds || '[]');
            
            if (foodIds.length === 0) {
                return;
            }
            
            let todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            if (!todayData.foods) todayData.foods = [];
            
            const mealLabels = {
                breakfast: 'Kahvaltı',
                lunch: 'Öğle Yemeği',
                dinner: 'Akşam Yemeği',
                snack: 'Ara Öğün'
            };
            
            let movedCount = 0;
            foodIds.forEach(foodId => {
                const foodIndex = todayData.foods.findIndex(f => f.id === foodId);
                if (foodIndex !== -1) {
                    todayData.foods[foodIndex].mealType = newMealType;
                    movedCount++;
                }
            });
            
            localStorage.setItem('nutritrack_today', JSON.stringify(todayData));
            
            // Geçmiş verileri de güncelle
            const today = new Date().toISOString().split('T')[0];
            let historyData = JSON.parse(localStorage.getItem('nutritrack_history') || '{}');
            
            if (historyData[today]) {
                foodIds.forEach(foodId => {
                    const foodIndex = historyData[today].foods.findIndex(f => f.id === foodId);
                    if (foodIndex !== -1) {
                        historyData[today].foods[foodIndex].mealType = newMealType;
                    }
                });
                localStorage.setItem('nutritrack_history', JSON.stringify(historyData));
            }
            
            // Checkbox'ları temizle
            foodIds.forEach(id => {
                const checkbox = document.querySelector(`.food-checkbox[data-food-id="${id}"]`);
                if (checkbox) checkbox.checked = false;
            });
            
            updateTodayFoodsList();
            updateBulkActions();
            modal.classList.remove('active');
            
            showNotification(`${movedCount} besin ${mealLabels[newMealType]}'e taşındı!`);
        }

        // Yiyecek silme
        function removeFood(foodId) {
            // Onay dialog'u göster
            if (!confirm('Bu besini kaldırmak istediğinize emin misiniz?')) {
                return;
            }

            let todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            const foodIndex = todayData.foods.findIndex(f => f.id === foodId);
            
            if (foodIndex !== -1) {
                const removedFood = todayData.foods[foodIndex];
                todayData.calories -= removedFood.calories;
                todayData.foods.splice(foodIndex, 1);
                
                localStorage.setItem('nutritrack_today', JSON.stringify(todayData));
                
                // App state'ini güncelle ki mikro besinler anında hesaplansın
                if (typeof app !== 'undefined') {
                    app.todayData = todayData;
                    if (typeof app.saveTodayData === 'function') {
                        app.saveTodayData();
                    }
                }
                
                showNotification('Besin kaldırıldı', 'success');
                
                // Geçmiş verilerden de sil
                const today = new Date().toISOString().split('T')[0];
                let historyData = JSON.parse(localStorage.getItem('nutritrack_history') || '{}');
                
                if (historyData[today]) {
                    const historyFoodIndex = historyData[today].foods.findIndex(f => f.id === foodId);
                    if (historyFoodIndex !== -1) {
                        historyData[today].calories -= removedFood.calories;
                        historyData[today].foods.splice(historyFoodIndex, 1);
                        localStorage.setItem('nutritrack_history', JSON.stringify(historyData));
                    }
                }
                
                updateTodayFoodsList();
                updateMicronutrients();
                showNotification(`${removedFood.name} silindi! (-${removedFood.calories} kcal)`);
            }
        }

        // Bildirim gösterme
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#ff4757' : '#667eea';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Enter tuşu ile arama
        document.getElementById('foodSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFood();
            }
        });

        // Animasyon stilleri (nutrition.html için)
        const nutritionAnimStyle = document.createElement('style');
        nutritionAnimStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(nutritionAnimStyle);

        // Modal dışına tıklanınca kapat
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('mealSelectModal');
            if (modal && event.target === modal) {
                modal.classList.remove('active');
            }
        });

        // Tema yönetimi
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme, true); // true = transition aktif
        }

        function setTheme(theme, enableTransition = false) {
            if (enableTransition) {
                // Transition'ı aktif et
                document.documentElement.classList.add('theme-transition');
            }
            
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('nutritrack_theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // En çok tüketilen besinleri hesapla
        function calculatePopularFoods() {
            const historyData = JSON.parse(localStorage.getItem('nutritrack_history') || '{}');
            const todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            const foodStats = {};
            
            // Bugünkü verileri de dahil et
            if (todayData.foods && Array.isArray(todayData.foods)) {
                todayData.foods.forEach(food => {
                    const key = `${food.name}_${food.brand}_${food.mealType || 'snack'}`;
                    if (!foodStats[key]) {
                        foodStats[key] = {
                            name: food.name,
                            brand: food.brand,
                            mealType: food.mealType || 'snack',
                            totalAmount: 0,
                            totalCalories: 0,
                            count: 0
                        };
                    }
                    foodStats[key].totalAmount += food.amount || 0;
                    foodStats[key].totalCalories += food.calories || 0;
                    foodStats[key].count += 1;
                });
            }
            
            // Tüm geçmiş verilerden besinleri topla
            Object.keys(historyData).forEach(date => {
                const dayData = historyData[date];
                if (dayData.foods && Array.isArray(dayData.foods)) {
                    dayData.foods.forEach(food => {
                        const key = `${food.name}_${food.brand}_${food.mealType || 'snack'}`;
                        if (!foodStats[key]) {
                            foodStats[key] = {
                                name: food.name,
                                brand: food.brand,
                                mealType: food.mealType || 'snack',
                                totalAmount: 0,
                                totalCalories: 0,
                                count: 0
                            };
                        }
                        foodStats[key].totalAmount += food.amount || 0;
                        foodStats[key].totalCalories += food.calories || 0;
                        foodStats[key].count += 1;
                    });
                }
            });
            
            // Ortalama hesapla ve sırala
            const popularFoods = Object.values(foodStats).map(food => ({
                ...food,
                avgAmount: food.totalAmount / food.count,
                avgCalories: food.totalCalories / food.count
            })).sort((a, b) => b.count - a.count); // En çok tüketilene göre sırala
            
            return popularFoods;
        }

        // Öğün bazlı en çok tüketilen besinleri getir
        function getPopularFoodsByMeal(mealType) {
            const popularFoods = calculatePopularFoods();
            return popularFoods
                .filter(food => food.mealType === mealType)
                .slice(0, 5); // En çok tüketilen 5 besin
        }

        // Önerileri göster
        function showRecommendations(mealType) {
            const recommendationsSection = document.getElementById('recommendationsSection');
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (!mealType) {
                recommendationsSection.style.display = 'none';
                return;
            }
            
            const popularFoods = getPopularFoodsByMeal(mealType);
            
            if (popularFoods.length === 0) {
                recommendationsSection.style.display = 'none';
                return;
            }
            
            recommendationsSection.style.display = 'block';
            
            const mealLabels = {
                breakfast: 'Kahvaltı',
                lunch: 'Öğle Yemeği',
                dinner: 'Akşam Yemeği',
                snack: 'Ara Öğün'
            };
            
            recommendationsList.innerHTML = popularFoods.map((food, index) => `
                <div class="recommendation-item" onclick="openMealSelectForRecommendation('${food.name.replace(/'/g, "\\'")}', '${food.brand.replace(/'/g, "\\'")}', ${food.mealType ? `'${food.mealType}'` : 'null'})">
                    <span>${food.name}</span>
                    <span class="recommendation-badge">${food.count}x</span>
                </div>
            `).join('');
        }

        // Öneri için öğün seçim modal'ını aç
        function openMealSelectForRecommendation(foodName, brand, suggestedMeal) {
            selectedRecommendation = { foodName, brand, suggestedMeal };
            document.getElementById('mealSelectModal').classList.add('active');
        }

        // Tarif için öğün seçim modal'ını aç
        function openMealSelectForRecipe(recipeId) {
            selectedRecipeForQuickAdd = recipeId;
            document.getElementById('mealSelectModal').classList.add('active');
        }

        // Önerilen besini seç (eski fonksiyon - şimdi sadece arama yapıyor)
        async function selectRecommendedFood(foodName, brand, targetMealType) {
            try {
                // Önce arama yap
                document.getElementById('foodSearch').value = foodName;
                
                // Önerileri gizle
                document.getElementById('recommendationsSection').style.display = 'none';
                
                // Arama yap (hata yönetimi ile)
                try {
                    await searchFood();
                } catch (error) {
                    console.error('Arama hatası:', error);
                    // Hata olsa bile devam et
                }
                
                // Arama sonuçlarında bul ve seç
                setTimeout(() => {
                    const results = document.querySelectorAll('.food-item');
                    let found = false;
                    
                    results.forEach(item => {
                        if (found) return;
                        
                        const nameElement = item.querySelector('.food-name');
                        if (nameElement) {
                            const itemName = nameElement.textContent.toLowerCase();
                            const searchName = foodName.toLowerCase();
                            
                            // Tam eşleşme veya içerme kontrolü
                            if (itemName === searchName || itemName.includes(searchName) || searchName.includes(itemName)) {
                                try {
                                    item.click();
                                    found = true;
                                    
                                    // Varsayılan miktarı ayarla (ortalama miktar)
                                    const popularFoods = calculatePopularFoods();
                                    const matchingFood = popularFoods.find(f => 
                                        f.name.toLowerCase() === foodName.toLowerCase() && 
                                        f.brand.toLowerCase() === brand.toLowerCase()
                                    );
                                    
                                    if (matchingFood && matchingFood.avgAmount) {
                                        setTimeout(() => {
                                            const portionInput = document.getElementById('portionInput');
                                            if (portionInput) {
                                                portionInput.value = Math.round(matchingFood.avgAmount);
                                                updateNutrition();
                                            }
                                        }, 300);
                                    }
                                } catch (clickError) {
                                    console.error('Tıklama hatası:', clickError);
                                }
                            }
                        }
                    });
                    
                    if (!found) {
                        showNotification('Besin bulunamadı. Lütfen manuel olarak arayın.', 'error');
                    }
                }, 1000);
            } catch (error) {
                console.error('Önerilen besin seçme hatası:', error);
                showNotification('Bir hata oluştu. Lütfen manuel olarak arayın.', 'error');
            }
        }

        // Öğün label'ını al
        function getMealLabel(mealType) {
            const labels = {
                'breakfast': 'Kahvaltı',
                'lunch': 'Öğle Yemeği',
                'dinner': 'Akşam Yemeği',
                'snack': 'Ara Öğün'
            };
            return labels[mealType] || 'Öğün';
        }

        // Öğün değiştiğinde önerileri güncelle
        document.getElementById('mealType').addEventListener('change', function() {
            const mealType = this.value;
            showRecommendations(mealType);
        });

        // Tarifleri göster
        function showRecipes() {
            const recipesSection = document.getElementById('recipesSection');
            const recipesList = document.getElementById('recipesList');
            
            const recipes = JSON.parse(localStorage.getItem('nutritrack_recipes') || '[]');
            
            if (recipes.length === 0) {
                recipesSection.style.display = 'block';
                recipesList.classList.add('empty');
                recipesList.innerHTML = `
                    <div class="recipes-empty">
                        <i class="fas fa-book-open"></i>
                        <div>Henüz tarif eklemediniz.</div>
                        <div class="muted">Tarif ekleyerek hızlıca öğün oluşturabilirsiniz.</div>
                    </div>
                `;
                return;
            }
            
            recipesSection.style.display = 'block';
            recipesList.classList.remove('empty');
            
            recipesList.innerHTML = recipes.slice(0, 5).map(recipe => `
                <div class="recommendation-item" onclick="openMealSelectForRecipe(${recipe.id})">
                    <span>🍳 ${recipe.name}</span>
                    <span class="recommendation-badge">${recipe.nutrientsPerServing.calories} kcal</span>
                </div>
            `).join('');
        }

        // Öneriyi seçilen öğüne ekle
        async function addRecommendationToMeal(mealType) {
            if (!selectedRecommendation) return;
            
            const { foodName, brand } = selectedRecommendation;
            
            // Önce arama yap
            document.getElementById('foodSearch').value = foodName;
            
            // Önerileri gizle
            document.getElementById('recommendationsSection').style.display = 'none';
            
            // Modal'ı kapat
            document.getElementById('mealSelectModal').classList.remove('active');
            selectedRecommendation = null;
            
            // Öğün seçimini ayarla
            document.getElementById('mealType').value = mealType;
            
            // Arama yap
            try {
                await searchFood();
                
                // Sonuçları bekle ve ilk eşleşeni seç
                setTimeout(() => {
                    const results = document.querySelectorAll('.food-item');
                    if (results.length > 0) {
                        results[0].click(); // İlk sonucu seç
                        
                        // Detaylar açıldığında otomatik ekle
                        setTimeout(() => {
                            const addBtn = document.querySelector('.add-food-btn');
                            if (addBtn) {
                                showNotification(`${foodName} ${getMealLabel(mealType)}'e ekleniyor...`);
                            }
                        }, 500);
                    }
                }, 1000);
            } catch (error) {
                console.error('Öneri ekleme hatası:', error);
                showNotification('Bir hata oluştu', 'error');
            }
        }

        // Tarifi seçilen öğüne ekle (öğün seçildikten sonra porsiyon modal'ını açar)
        function addRecipeToMeal(mealType) {
            if (!selectedRecipeForQuickAdd) return;
            
            const recipes = JSON.parse(localStorage.getItem('nutritrack_recipes') || '[]');
            const recipe = recipes.find(r => r.id === selectedRecipeForQuickAdd);
            
            if (!recipe) return;

            // Öğün seçim modal'ını kapat
            document.getElementById('mealSelectModal').classList.remove('active');

            // Öğün tipini sakla
            pendingRecipeMealType = mealType;

            // Porsiyon seçim modal'ını aç
            const servingModal = document.getElementById('servingSelectModal');
            const servingTitle = document.getElementById('servingSelectTitle');
            const servingSubtitle = document.getElementById('servingSelectSubtitle');
            const servingInput = document.getElementById('servingInput');

            servingTitle.textContent = `"${recipe.name}" için kaç porsiyon?`;
            servingSubtitle.textContent = `Tarif ${recipe.servings} porsiyonluk`;
            servingInput.value = '1';
            servingInput.focus();
            servingInput.select();

            servingModal.classList.add('active');
        }

        // Porsiyon seçim modal'ını kapat
        function closeServingModal() {
            document.getElementById('servingSelectModal').classList.remove('active');
            selectedRecipeForQuickAdd = null;
            pendingRecipeMealType = null;
        }

        // Porsiyon onaylandığında tarifi ekle
        function confirmServing() {
            if (!selectedRecipeForQuickAdd || !pendingRecipeMealType) return;

            const recipes = JSON.parse(localStorage.getItem('nutritrack_recipes') || '[]');
            const recipe = recipes.find(r => r.id === selectedRecipeForQuickAdd);
            
            if (!recipe) {
                closeServingModal();
                return;
            }

            const servingInput = document.getElementById('servingInput');
            const servings = parseFloat(servingInput.value);
            
            // Geçerli bir sayı kontrolü
            if (isNaN(servings) || servings <= 0) {
                showNotification('Lütfen geçerli bir porsiyon sayısı girin!', 'error');
                servingInput.focus();
                servingInput.select();
                return;
            }

            // Modal'ı kapat
            closeServingModal();

            // Tarifi besin olarak ekle
            let todayData = JSON.parse(localStorage.getItem('nutritrack_today') || '{}');
            if (!todayData.foods) todayData.foods = [];
            if (!todayData.calories) todayData.calories = 0;

            // Mikro besinleri porsiyon sayısına göre çarp
            const scaledMicronutrients = {};
            if (recipe.micronutrientsPerServing) {
                Object.keys(recipe.micronutrientsPerServing).forEach(key => {
                    const nutrient = recipe.micronutrientsPerServing[key];
                    if (typeof nutrient === 'object' && nutrient.value !== undefined) {
                        scaledMicronutrients[key] = {
                            value: nutrient.value * servings,
                            unit: nutrient.unit
                        };
                    } else {
                        scaledMicronutrients[key] = nutrient * servings;
                    }
                });
            }

            const foodItem = {
                id: Date.now(),
                name: `${recipe.name} (Tarif)`,
                brand: `${servings} porsiyon`,
                amount: servings * 100,
                calories: Math.round(recipe.nutrientsPerServing.calories * servings),
                mealType: pendingRecipeMealType,
                nutrients: {
                    calories: Math.round(recipe.nutrientsPerServing.calories * servings),
                    protein: Math.round((recipe.nutrientsPerServing.protein * servings) * 100) / 100,
                    carbs: Math.round((recipe.nutrientsPerServing.carbs * servings) * 100) / 100,
                    fat: Math.round((recipe.nutrientsPerServing.fat * servings) * 100) / 100,
                    ...scaledMicronutrients
                },
                isRecipe: true,
                recipeId: recipe.id
            };

            todayData.foods.push(foodItem);
            todayData.calories += foodItem.calories;
            localStorage.setItem('nutritrack_today', JSON.stringify(todayData));

            // Geçmiş verilere de kaydet
            const today = new Date().toISOString().split('T')[0];
            let historyData = JSON.parse(localStorage.getItem('nutritrack_history') || '{}');
            
            if (!historyData[today]) {
                historyData[today] = { foods: [], calories: 0, water: todayData.water || 0 };
            }
            
            historyData[today].foods.push(foodItem);
            historyData[today].calories += foodItem.calories;
            localStorage.setItem('nutritrack_history', JSON.stringify(historyData));

            updateTodayFoodsList();
            updateMicronutrients();
            showNotification(`"${recipe.name}" ${getMealLabel(pendingRecipeMealType)}'e ${servings} porsiyon eklendi! (+${foodItem.calories} kcal)`);
        }

        // Sayfa yüklendiğinde bugünkü yiyecekleri göster
        document.addEventListener('DOMContentLoaded', function() {
            // Tema zaten <head> içinde uygulandı, transition'ı kapat
            document.documentElement.classList.remove('theme-transition');
            
            // Icon'u güncelle
            const savedTheme = localStorage.getItem('nutritrack_theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Porsiyon modal'ı için event listener'lar
            // Modal dışına tıklandığında kapat
            const servingModal = document.getElementById('servingSelectModal');
            if (servingModal) {
                servingModal.addEventListener('click', function(event) {
                    if (event.target === servingModal) {
                        closeServingModal();
                    }
                });
            }

            // Enter tuşu ile onaylama
            const servingInput = document.getElementById('servingInput');
            if (servingInput) {
                servingInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmServing();
                    }
                });
            }
            updateTodayFoodsList();
            updateMicronutrients(); // Mikro besinleri güncelle
            showRecipes(); // Tarifleri göster
            loadCachedFoods(); // Cache'den hızlı ekleme listesi
            
            // Öğün değiştiğinde önerileri ve tarifleri güncelle
            const mealTypeSelect = document.getElementById('mealType');
            if (mealTypeSelect) {
                mealTypeSelect.addEventListener('change', function() {
                    const mealType = this.value;
                    showRecommendations(mealType);
                    showRecipes(); // Tarifleri de göster
                });
                
                // Varsayılan öğün için önerileri göster
                const defaultMeal = mealTypeSelect.value;
                showRecommendations(defaultMeal);
            }
        });

        // MİKRO BESİN TAKİBİ FONKSİYONLARI
        let currentMicroTab = 'all';

        // CACHE'DEN HIZLI EKLEME
        let selectedCacheFoodId = null;

        async function loadCachedFoods() {
            const list = document.getElementById('cacheList');
            if (!list) return;
            if (typeof foodCache === 'undefined') {
                list.innerHTML = '<div class="cache-empty">Cache sistemi hazır değil.</div>';
                return;
            }
            list.innerHTML = '<div class="cache-empty"><i class="fas fa-spinner fa-spin"></i> Yükleniyor...</div>';
            try {
                const foods = await foodCache.searchFoods('');
                if (!foods || foods.length === 0) {
                    list.innerHTML = '<div class="cache-empty">Henüz cache dolu değil. Aradığınız besinler otomatik kaydedilecek.</div>';
                    return;
                }
                const topFoods = foods.slice(0, 30);
                list.innerHTML = topFoods.map(food => `
                    <div class="cache-chip" onclick="openCacheMealPicker(${food.fdcId})">
                        <div>
                            <div class="cache-name">${food.description || 'Bilinmeyen'}</div>
                            <div class="cache-brand">${food.brandOwner || 'Genel'}</div>
                        </div>
                        <button class="cache-add-btn" type="button">Ekle</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Cache okuma hatası', error);
                list.innerHTML = '<div class="cache-empty">Cache okunamadı.</div>';
            }
        }

        function openCacheMealPicker(fdcId) {
            selectedCacheFoodId = fdcId;
            const modal = document.getElementById('cacheMealModal');
            if (modal) modal.classList.add('active');
        }

        function closeCacheMealModal(event) {
            if (!event || event.target === event.currentTarget) {
                const modal = document.getElementById('cacheMealModal');
                if (modal) modal.classList.remove('active');
                selectedCacheFoodId = null;
            }
        }

        async function confirmAddCachedFood(mealType) {
            if (!selectedCacheFoodId) {
                closeCacheMealModal();
                return;
            }
            await addCachedFood(selectedCacheFoodId, mealType);
            closeCacheMealModal();
        }

        async function addCachedFood(fdcId, mealTypeOverride = null) {
            if (typeof foodCache === 'undefined') {
                showNotification('Cache sistemi hazır değil', 'error');
                return;
            }
            try {
                const cached = await foodCache.getFood(fdcId);
                if (!cached) {
                    showNotification('Cache kaydı bulunamadı veya süresi dolmuş', 'error');
                    loadCachedFoods();
                    return;
                }
                // currentFood ve baseNutrients hazırla
                currentFood = cached;
                baseNutrients = {};
                cached.foodNutrients.forEach(nutrient => {
                    baseNutrients[nutrient.nutrientName] = {
                        value: nutrient.value,
                        unit: nutrient.unitName
                    };
                });
                // Besin bilgilerini göster
                document.getElementById('foodTitle').textContent = cached.description || 'Bilinmeyen';
                document.getElementById('foodBrand').textContent = cached.brandOwner || 'Genel';
                document.getElementById('nutritionDetails').style.display = 'block';
                // Seçilen öğün ayarla (override varsa kullan)
                const mealSelect = document.getElementById('mealType');
                if (mealSelect && mealTypeOverride) {
                    mealSelect.value = mealTypeOverride;
                }
                // Seçilen öğün ve miktarı kullanarak ekle
                addFood();
            } catch (error) {
                console.error('Cache ekleme hatası', error);
                showNotification('Cache\'den eklenemedi', 'error');
            }
        }

        // Mikro besinleri güncelle
        function updateMicronutrients() {
            // app objesi yüklenene kadar bekle
            if (typeof app === 'undefined') {
                setTimeout(updateMicronutrients, 100);
                return;
            }
            const micronutrients = app.calculateDailyMicronutrients();
            displayMicronutrients(micronutrients, currentMicroTab);
        }

        // Mikro besinleri görüntüle
        function displayMicronutrients(micronutrients, filterType = 'all') {
            const container = document.getElementById('micronutrientsContainer');
            
            if (!micronutrients || micronutrients.length === 0) {
                container.innerHTML = `
                    <div class="no-micronutrients">
                        <i class="fas fa-flask" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Henüz besin eklemediniz. Besin ekledikçe mikro besin takibi burada görünecek.</p>
                    </div>
                `;
                return;
            }

            // Filtrele
            let filteredNutrients = micronutrients;
            if (filterType === 'vitamins') {
                filteredNutrients = micronutrients.filter(n => 
                    n.name.includes('Vitamin') || n.name.includes('vitamin')
                );
            } else if (filterType === 'minerals') {
                filteredNutrients = micronutrients.filter(n => 
                    !n.name.includes('Vitamin') && !n.name.includes('vitamin') && !n.name.includes('Lif')
                );
            } else if (filterType === 'deficient') {
                filteredNutrients = micronutrients.filter(n => 
                    n.percentage < 70 && !n.isLimit
                );
            }

            if (filteredNutrients.length === 0) {
                container.innerHTML = `
                    <div class="no-micronutrients">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; color: #27ae60;"></i>
                        <p>Bu kategoride eksik besin yok! 🎉</p>
                    </div>
                `;
                return;
            }

            // Kart HTML'ini oluştur
            const cardsHTML = filteredNutrients.map(nutrient => {
                const badgeClass = `badge-${nutrient.status}`;
                const cardClass = `status-${nutrient.status}`;
                const progressClass = `progress-bar-${nutrient.status}`;
                
                const statusText = {
                    'low': 'Çok Düşük',
                    'fair': 'Düşük',
                    'good': 'İyi',
                    'complete': 'Tamamlandı',
                    'over': 'Fazla',
                    'warning': 'Uyarı'
                };

                const statusIcon = {
                    'low': '⚠️',
                    'fair': '📊',
                    'good': '✅',
                    'complete': '🎯',
                    'over': '⚠️',
                    'warning': '⚠️'
                };

                return `
                    <div class="micronutrient-card ${cardClass}">
                        <div class="micronutrient-header">
                            <span class="micronutrient-name">${nutrient.name}</span>
                            <span class="micronutrient-badge ${badgeClass}">
                                ${statusIcon[nutrient.status]} ${statusText[nutrient.status]}
                            </span>
                        </div>
                        <div class="micronutrient-values">
                            <span class="consumed-value">${nutrient.consumed} ${nutrient.unit}</span>
                            <span class="target-value">/ ${nutrient.target} ${nutrient.unit} ${nutrient.isLimit ? '(Maks)' : '(Hedef)'}</span>
                        </div>
                        <div class="micronutrient-progress">
                            <div class="micronutrient-progress-bar ${progressClass}" style="width: ${nutrient.percentage}%"></div>
                        </div>
                        <div class="micronutrient-percentage">
                            %${Math.round(nutrient.actualPercentage)}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="micronutrient-grid">${cardsHTML}</div>`;
        }

        // Tab değiştir
        function showMicroTab(tabType) {
            currentMicroTab = tabType;
            
            // Tab butonlarını güncelle
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Mikro besinleri güncelle
            if (typeof app !== 'undefined') {
                const micronutrients = app.calculateDailyMicronutrients();
                displayMicronutrients(micronutrients, tabType);
            }
        }

        // Eksik besin uyarılarını göster
        function showDeficiencyWarnings() {
            if (typeof app === 'undefined') return;
            
            const deficient = app.getDeficientNutrients();
            
            if (deficient.length === 0) return;
            
            // Sadece çok düşük olanları göster (<%30)
            const critical = deficient.filter(n => n.percentage < 30);
            
            if (critical.length > 0) {
                const names = critical.map(n => n.name).slice(0, 3).join(', ');
                const message = `⚠️ Bugün ${names} alımınız çok düşük. Bu besinleri içeren yiyecekler eklemeyi düşünün.`;
                
                // Uyarı bildirimi göster (3 saniye sonra)
                setTimeout(() => {
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = `
                        position: fixed;
                        bottom: 100px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #ff6b6b, #ff4757);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 15px;
                        box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
                        z-index: 9999;
                        max-width: 400px;
                        text-align: center;
                        font-size: 0.9rem;
                        animation: slideInUp 0.5s ease;
                    `;
                    warningDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">${message}</div>
                        <button onclick="this.parentElement.remove()" style="background: white; color: #ff4757; border: none; padding: 5px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Tamam
                        </button>
                    `;
                    document.body.appendChild(warningDiv);
                    
                    // 10 saniye sonra otomatik kapat
                    setTimeout(() => {
                        if (warningDiv.parentElement) {
                            warningDiv.style.animation = 'slideOutDown 0.5s ease';
                            setTimeout(() => warningDiv.remove(), 500);
                        }
                    }, 10000);
                }, 3000);
            }
        }

        // Animasyon stilleri ekle
        if (!document.getElementById('deficiencyAnimations')) {
            const animStyle = document.createElement('style');
            animStyle.id = 'deficiencyAnimations';
            animStyle.textContent = `
                @keyframes slideInUp {
                    from { transform: translate(-50%, 100%); opacity: 0; }
                    to { transform: translate(-50%, 0); opacity: 1; }
                }
                @keyframes slideOutDown {
                    from { transform: translate(-50%, 0); opacity: 1; }
                    to { transform: translate(-50%, 100%); opacity: 0; }
                }
            `;
            document.head.appendChild(animStyle);
        }

        // Yiyecek eklendiğinde veya silindiğinde mikro besinleri güncelle ve uyarıları göster
        const originalAddFood = addFood;
        addFood = function() {
            originalAddFood();
            setTimeout(() => {
                updateMicronutrients();
                showDeficiencyWarnings(); // Eksik besin uyarılarını göster
            }, 500);
        };

        const originalRemoveFood = removeFood;
        removeFood = function(foodId) {
            originalRemoveFood(foodId);
            setTimeout(() => {
                updateMicronutrients();
            }, 500);
        };
    </script>
</body>
</html>